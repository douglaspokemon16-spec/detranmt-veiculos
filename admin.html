<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background: #f4f6f9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }
        .card-dashboard {
            border: none;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .card-dashboard:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
        }
        .stat-icon {
            font-size: 2.5rem;
            color: #336699;
            opacity: 0.3;
            position: absolute;
            right: 20px;
            top: 20px;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: #333;
        }
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .table-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        .table thead th {
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
        }
        .badge-device {
            background: #e9ecef;
            color: #495057;
            padding: 5px 10px;
            border-radius: 50px;
            font-size: 0.75rem;
        }
        .pix-config {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        .btn-pix {
            background: #336699;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .btn-pix:hover {
            background: #254e6b;
        }
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .logout-btn:hover {
            background: #bb2d3b;
        }
        .editing {
            background-color: #fff3cd;
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="container login-container">
        <div class="card card-dashboard p-4">
            <div class="text-center mb-4">
                <img src="/assets/headermt.png" alt="Logo" style="max-width: 200px;" onerror="this.src='/banner.png'; this.onerror=null;">
                <h3 class="mt-3">Acesso ao Painel</h3>
            </div>
            <div class="mb-3">
                <label class="form-label">Usuário</label>
                <input type="text" id="usuario" class="form-control" placeholder="Digite seu usuário">
            </div>
            <div class="mb-3">
                <label class="form-label">Senha</label>
                <input type="password" id="senha" class="form-control" placeholder="Digite sua senha">
            </div>
            <button class="btn btn-pix w-100" onclick="fazerLogin()">Entrar</button>
            <div id="erroLogin" class="text-danger mt-2 text-center"></div>
        </div>
    </div>

    <div id="dashboardScreen" style="display: none;">
        <nav class="navbar navbar-light bg-white shadow-sm px-4">
            <span class="navbar-brand">
                <img src="/assets/headermt.png" height="30" alt="Logo" onerror="this.src='/banner.png'; this.onerror=null;">
                <span class="ms-2 fw-bold">Painel Administrativo</span>
            </span>
            <div>
                <span class="me-3 text-muted" id="usuarioLogado"></span>
                <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Sair</button>
            </div>
        </nav>

        <div class="container-fluid p-4">
            <!-- Cards de estatísticas -->
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card card-dashboard p-3 position-relative">
                        <div class="stat-icon"><i class="fas fa-credit-card"></i></div>
                        <div class="stat-value" id="totalPagamentos">0</div>
                        <div class="stat-label">Total de Pagamentos</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-dashboard p-3 position-relative">
                        <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                        <div class="stat-value" id="totalValor">R$ 0</div>
                        <div class="stat-label">Valor Total Pagamentos</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-dashboard p-3 position-relative">
                        <div class="stat-icon"><i class="fas fa-mouse-pointer"></i></div>
                        <div class="stat-value" id="totalCliques">0</div>
                        <div class="stat-label">Total de Cliques</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-dashboard p-3 position-relative">
                        <div class="stat-icon"><i class="fas fa-copy"></i></div>
                        <div class="stat-value" id="totalPixCopiados">0</div>
                        <div class="stat-label">PIX Copiados</div>
                    </div>
                </div>
            </div>
            <!-- Segundo linha de cards -->
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card card-dashboard p-3 position-relative">
                        <div class="stat-icon"><i class="fas fa-coins"></i></div>
                        <div class="stat-value" id="totalValorPixCopiados">R$ 0</div>
                        <div class="stat-label">Valor PIX Copiados</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-dashboard p-3 position-relative">
                        <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
                        <div class="stat-value" id="pagamentosHoje">0</div>
                        <div class="stat-label">Pagamentos Hoje</div>
                    </div>
                </div>
            </div>

            <!-- Configuração da Chave PIX -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="pix-config">
                        <h5><i class="fas fa-cog me-2"></i>Configurar Chave PIX</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Chave (aleatória, CPF, e-mail, telefone)</label>
                                <input type="text" id="chavePix" class="form-control" placeholder="Ex: 123e4567-e89b-12d3-a456-426614174000">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Cidade</label>
                                <input type="text" id="cidadePix" class="form-control" placeholder="Cidade do recebedor">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Nome do Recebedor</label>
                                <input type="text" id="nomePix" class="form-control" placeholder="Nome completo ou razão social">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Identificador (opcional)</label>
                                <input type="text" id="idPix" class="form-control" placeholder="Ex: ID123">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-pix" onclick="salvarChavePix()">Salvar Configurações</button>
                        </div>
                        <div class="mt-2 text-success" id="msgChave"></div>
                    </div>
                </div>
            </div>

            <!-- Botão Limpar Dados -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="pix-config">
                        <h5><i class="fas fa-trash-alt me-2"></i>Administração</h5>
                        <button class="btn btn-danger" onclick="limparDados()">Limpar todos os dados (pagamentos, cliques, PIX copiados)</button>
                    </div>
                </div>
            </div>

            <!-- Tabela de Últimos Pagamentos -->
            <div class="table-container">
                <h5 class="mb-3"><i class="fas fa-history me-2"></i>Últimos 15 Pagamentos</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Placa</th>
                                <th>Localização</th>
                                <th>Dispositivo</th>
                                <th>Valor</th>
                                <th>IP</th>
                                <th>Data/Hora</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaPagamentos">
                            <tr><td colspan="6" class="text-center">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('token');
        let usuario = localStorage.getItem('usuario') || '';
        let autoRefreshInterval;
        let isEditing = false; // Flag para pausar auto-refresh durante edição

        if (token) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            document.getElementById('usuarioLogado').innerText = usuario;
            // Carrega configurações uma única vez
            carregarConfiguracoes();
            // Inicia atualização periódica do dashboard (apenas estatísticas e tabela)
            iniciarAutoRefresh();
        }

        function iniciarAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                if (!isEditing) {
                    atualizarDashboard();
                }
            }, 5000);
        }

        function pararAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        }

        function fazerLogin() {
            const usuario = document.getElementById('usuario').value.trim();
            const senha = document.getElementById('senha').value;

            fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usuario, senha })
            })
            .then(res => res.json())
            .then(data => {
                if (data.token) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    localStorage.setItem('usuario', usuario);
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('dashboardScreen').style.display = 'block';
                    document.getElementById('usuarioLogado').innerText = usuario;
                    carregarConfiguracoes(); // só uma vez
                    iniciarAutoRefresh();
                } else {
                    document.getElementById('erroLogin').innerText = 'Usuário ou senha inválidos';
                }
            })
            .catch(() => {
                document.getElementById('erroLogin').innerText = 'Erro de conexão';
            });
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('usuario');
            token = null;
            pararAutoRefresh();
            document.getElementById('dashboardScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
        }

        // Função que atualiza apenas estatísticas e tabela (chamada pelo intervalo)
        function atualizarDashboard() {
            if (!token) return;

            const headers = { 'Authorization': token };

            // Estatísticas
            fetch('/api/estatisticas', { headers })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('totalPagamentos').innerText = data.total_pagamentos || 0;
                    document.getElementById('totalValor').innerText = 'R$ ' + (data.total_valor_pagamentos || 0).toFixed(2).replace('.', ',');
                    document.getElementById('totalCliques').innerText = data.total_cliques || 0;
                    document.getElementById('totalPixCopiados').innerText = data.total_pix_copiados || 0;
                    document.getElementById('totalValorPixCopiados').innerText = 'R$ ' + (data.total_valor_pix_copiados || 0).toFixed(2).replace('.', ',');
                    document.getElementById('pagamentosHoje').innerText = data.pagamentos_hoje || 0;
                })
                .catch(console.error);

            // Últimos pagamentos
            fetch('/api/pagamentos', { headers })
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('tabelaPagamentos');
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum pagamento registrado.</td></tr>';
                        return;
                    }
                    tbody.innerHTML = '';
                    data.forEach(p => {
                        tbody.innerHTML += `
                            <tr>
                                <td><span class="badge bg-secondary">${p.placa || '-'}</span></td>
                                <td><i class="fas fa-map-marker-alt me-1 text-muted"></i>${p.cidade || ''} - ${p.estado || ''}</td>
                                <td><span class="badge-device"><i class="fas fa-${p.dispositivo === 'Mobile' ? 'mobile-alt' : 'desktop'} me-1"></i>${p.dispositivo || '-'}</span></td>
                                <td>R$ ${parseFloat(p.valor || 0).toFixed(2).replace('.', ',')}</td>
                                <td><small>${p.ip || '-'}</small></td>
                                <td><i class="far fa-clock me-1"></i>${p.data_hora || ''}</td>
                            </tr>
                        `;
                    });
                })
                .catch(console.error);
        }

        // Função que carrega as configurações do PIX (chamada apenas uma vez)
        function carregarConfiguracoes() {
            if (!token) return;
            const headers = { 'Authorization': token };
            fetch('/api/configuracao/pix', { headers })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('chavePix').value = data.chave || '';
                    document.getElementById('cidadePix').value = data.cidade || '';
                    document.getElementById('nomePix').value = data.nome || '';
                    document.getElementById('idPix').value = data.identificador || '';
                })
                .catch(console.error);
        }

        function salvarChavePix() {
            const chave = document.getElementById('chavePix').value;
            const cidade = document.getElementById('cidadePix').value;
            const nome = document.getElementById('nomePix').value;
            const identificador = document.getElementById('idPix').value;

            if (!chave || !cidade || !nome || !identificador) {
                alert('Todos os campos são obrigatórios!');
                return;
            }

            fetch('/api/configuracao/pix', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({ chave, cidade, nome, identificador })
            })
            .then(res => res.json())
            .then(data => {
                if (data.sucesso) {
                    document.getElementById('msgChave').innerHTML = '<i class="fas fa-check-circle me-1"></i>Configurações salvas com sucesso!';
                    setTimeout(() => document.getElementById('msgChave').innerHTML = '', 3000);
                    // Após salvar, recarrega as configurações para garantir consistência
                    carregarConfiguracoes();
                } else {
                    alert('Erro ao salvar: ' + (data.erro || 'desconhecido'));
                }
            })
            .catch(() => alert('Erro ao salvar'));
        }

        function limparDados() {
            if (!confirm('Tem certeza que deseja limpar todos os dados? Esta ação é irreversível.')) return;
            fetch('/api/limpar-dados', {
                method: 'POST',
                headers: { 'Authorization': token }
            })
            .then(res => res.json())
            .then(data => {
                if (data.sucesso) {
                    alert('Dados limpos com sucesso!');
                    // Atualiza o dashboard
                    atualizarDashboard();
                } else {
                    alert('Erro ao limpar dados.');
                }
            })
            .catch(() => alert('Erro de conexão.'));
        }

        // Detectar quando o usuário está editando os campos de configuração
        const camposPix = ['chavePix', 'cidadePix', 'nomePix', 'idPix'];
        camposPix.forEach(id => {
            const campo = document.getElementById(id);
            campo.addEventListener('focus', () => { isEditing = true; });
            campo.addEventListener('blur', () => { isEditing = false; });
        });
    </script>
</body>
</html>